// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            Int            @id @default(autoincrement())
  username      String         @unique
  email         String         @unique
  timeZone      String         @default("UTC")
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  
  eventTypes    EventType[]
  schedules     AvailabilitySchedule[]
  
  @@map("users")
}

model AvailabilitySchedule {
  id          Int      @id @default(autoincrement())
  name        String
  isDefault   Boolean  @default(false)
  userId      Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  availabilities Availability[]
  eventTypes    EventType[]
  overrides     DateOverride[]
  
  @@map("availability_schedules")
}

model DateOverride {
  id            Int      @id @default(autoincrement())
  date          DateTime // The specific date for the override
  startTime     String   // Start time "09:00"
  endTime       String   // End time "17:00"
  isUnavailable Boolean  @default(false)
  
  scheduleId    Int
  schedule      AvailabilitySchedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)

  @@unique([scheduleId, date]) // One override per date per schedule
  @@map("date_overrides")
}

model EventType {
  id          Int       @id @default(autoincrement())
  title       String
  duration    Int       // Duration in minutes
  urlSlug     String    @unique
  description String?
  color       String    @default("#006BFF")
  userId      Int
  scheduleId  Int?      // Optional: specific schedule for this event type
  bufferBefore Int      @default(0)  // Buffer time before meeting (minutes)
  bufferAfter  Int      @default(0)  // Buffer time after meeting (minutes)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  schedule    AvailabilitySchedule? @relation(fields: [scheduleId], references: [id], onDelete: SetNull)
  bookings    Booking[]
  customQuestions CustomQuestion[]
  
  @@map("event_types")
}

model Availability {
  id          Int      @id @default(autoincrement())
  dayOfWeek   Int      // 0 = Sunday, 1 = Monday, ..., 6 = Saturday
  startTime   String   // Format: "HH:MM" (e.g., "09:00")
  endTime     String   // Format: "HH:MM" (e.g., "17:00")
  scheduleId  Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  schedule    AvailabilitySchedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)
  
  @@map("availabilities")
}

model Booking {
  id            Int           @id @default(autoincrement())
  inviteeName   String
  inviteeEmail  String
  startTime     DateTime
  endTime       DateTime
  status        String        @default("CONFIRMED")  // "CONFIRMED" or "CANCELLED"
  
  // Custom Answers JSON
  customAnswers String? // JSON string: { "questionId": "answer" }
  
  eventTypeId   Int
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  
  eventType     EventType @relation(fields: [eventTypeId], references: [id], onDelete: Cascade)
  
  @@map("bookings")
}

model CustomQuestion {
  id          Int      @id @default(autoincrement())
  eventTypeId Int
  label       String   // The question text
  type        String   // "text", "textarea", "select", "phone"
  required    Boolean  @default(true)
  options     String?  // JSON string for select options: ["Option A", "Option B"]
  placeholder String?
  position    Int      @default(0) // For ordering
  
  eventType   EventType @relation(fields: [eventTypeId], references: [id], onDelete: Cascade)

  @@map("custom_questions")
}
